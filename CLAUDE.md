# プロジェクト概要

React + Hono + RPC を用いたフロントエンド・バックエンド統合テンプレート（認証付き）

* フロントエンド：React（Vite）
* バックエンド：Hono（Cloudflare Workers 前提）
* 通信方式：Hono RPC（型安全通信）
* データベース：Cloudflare D1（SQLite）+ Drizzle ORM

本リポジトリは **テンプレート用途** を目的としており、設計の分かりやすさ・拡張のしやすさを最優先とする。

---

# 主要コマンド

## フロントエンド (`frontend/`)

* `npm run dev`: 開発サーバー起動
* `npm run test`: テスト実行
* `npm run storybook`: Storybook 起動

## バックエンド (`backend/`)

* `npm run dev`: 開発サーバー起動
* `npm run test`: テスト実行
* `npm run db:generate`: マイグレーション SQL 生成
* `npm run db:migrate:local`: ローカル D1 にマイグレーション適用
* `npm run db:migrate:prod`: 本番 D1 にマイグレーション適用
* `npm run db:seed:local`: ローカル D1 に Seed データ投入
* `npm run deploy:prod`: 本番環境にデプロイ

---

# 新機能追加時の進め方

1. 調査
2. 計画
3. 実装
4. テスト

---

# バグ修正時の進め方

1. 原因調査
2. テスト作成（TDD）
3. 修正実装
4. 動作確認

---

# コーディング規約（共通）

* TypeScript の厳密モードを使用する
* 関数・コンポーネントは function 宣言で定義する
* スタイルは Tailwind CSS のみを使用する
* テストは Vitest で記述する

---

## 指示・回答について

* 回答は日本語で行うこと
* 指示をする側も人間であり、誤りが含まれる可能性がある
  * 指示内容は批判的に検討し、誤りがあれば指摘すること
* 指示内容を鵜呑みにせず、背景や説明不足を感じた場合は確認を取ること
* 指示された案以外にも選択肢がないか検討し、より良い案があれば提案すること

---

## 設計指針

* いきなりコードを書き始めず、まず設計案を提示すること
* 設計検討時は以下を順守する
  * 複数案を提示し、それぞれのメリット・デメリットを併記する
  * 現在の目的に対して最もシンプルかつメンテナンス性の高い案を1つ選定する
  * 将来どのような変更が入るとその案が破綻するかも併せて説明する

---

## RPC 設計指針（重要）

* バックエンドは REST API の URL 設計を前提とする
* フロントエンドは URL や HTTP メソッドを意識しない（RPC クライアント経由で呼び出す）
* RPC の型定義は **バックエンドを単一の source of truth** とする
* フロントエンドで API 用の型を新規定義しない
* Hono の app / router 定義から RPC クライアントを生成する
* fetch / axios を直接使用しない（ファイルアップロード等の例外を除く）
* RPC レスポンスに対して `as` による型アサーションを使用しない
  * `InferResponseType` / `InferRequestType` 等で型推論し、RPC の型安全性を維持する
  * アサーションが必要になる場合はバックエンドのレスポンス型定義に問題がある可能性を疑うこと
  * RPC以外の箇所についても型アサーションが必要になる場合は修正前に相談すること
* **バックエンドに `@/` パスエイリアスを追加しないこと（相対パスを使う）**
  * フロントエンドの tsconfig が `@/*` → `frontend/src/*` にマッピングしている
  * バックエンドに同様のエイリアスを追加すると、RPC 型チェーンでフロントエンド tsc がバックエンドファイルを処理する際に誤解決される
  * バックエンドの import は必ず `../../../domain` のような相対パスで記述する

---

## フロントエンド固有の設計指針

### API クライアントの使い分け

* 通常の API 呼び出しは `lib/rpc-client.ts` の `rpc` を使用する
* `lib/api-client.ts`（Axios）はリフレッシュトークンのエンドポイント専用
  * `rpc-client.ts` → `refresh-handler.ts` → `rpc-client.ts` の循環参照を避けるため
* 新しい API エンドポイントを追加する際は `rpc` を使うこと

### sample 機能

* `features/sample/` はテンプレートのリファレンス実装（Container / Presentational パターンの参考）
* 実際のプロジェクトでは削除または置き換える想定

---

## バックエンド固有の設計指針

### 環境変数の扱い（EnvConfig）

* 環境変数は `createEnvConfig(c.env)` ファクトリ関数で readonly オブジェクトに変換する
* ミドルウェア（`envInitMiddleware`）でリクエストごとに `c.set('envConfig', ...)` に格納する
* コントローラーは `c.get('envConfig')` で取得し、ドメインオブジェクトに引数として渡す
* グローバルシングルトンを使わない（Workers はリクエスト間で状態を共有しないため）

### 環境変数ファイルの使い分け

* `wrangler.jsonc` の `vars`: 非機密の設定値（トークン有効期限、CORS オリジン等）
* `backend/.dev.vars`: 機密情報（JWT 秘密鍵、PEPPER 等）— Git 管理しない
* `.dev.vars` は dotenv 形式のため、すべての値が文字列になる
* `.dev.vars` と `wrangler.jsonc` に同名の変数がある場合、`.dev.vars` が優先される

### Zod バージョン

* フロントエンド: Zod v4（`@hookform/resolvers@5.x` が Zod v4 のみ対応）
* バックエンド: Zod v3（`@hono/zod-validator@0.4.x` が Zod v3 のみ対応）
* 両者のバリデーションスキーマは RPC を通じて直接共有しないため、バージョンの違いは問題にならない
* 依存パッケージ更新時は各バリデータライブラリの Zod 対応バージョンを必ず確認すること

---

## コードレビュー指針

* コードレビュー時は、結論だけでなく調査プロセスも共有すること
* 結論には、それを裏付ける重要な根拠を併せて提示すること
* 常に **最新のファイル内容** を前提にレビューを行うこと
* レビュアーと実装者が一緒に妥当性を確認する姿勢を取ること

---

## 実装指針

* 段階的に進める（小さな変更を積み重ねる）
* 複数タスクを同時並行で進めない
* エラーは必ず解消してから次へ進む
* エラーを無視して進めない
* 指示にない機能を勝手に追加しない

---

## エラー対応指針

* 「なぜ期待と異なる挙動が起きたのか」を必ず深掘りしてから次の対応を検討する

---

# 注意事項（共通）

* 環境変数は .env / .dev.vars で管理する（コミット禁止）
* 以下のファイルの参照・出力・実行を禁止する
  * .env
  * *.env
  * .env.*
  * .dev.vars
* 秘密情報（APIキー、トークン、認証情報）を推測しない
* 明示的な指示がない限り、ファイルの作成・修正・削除を行わない
* GitHub に含めるべきでないファイルを作成する場合は、必ず .gitignore に追加する

## 修正作業時のルール

* 修正による影響範囲を慎重に確認すること
* 他の挙動にも修正が必要な場合は、既存の期待動作が保たれるよう対応すること
* 修正内容について **コミットは実施しない**

## その他

* 指示なくビルドを実行しないこと
